{% extends "layouts/base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8">

    <!-- Header / Search -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-6">
        <div>
            <h2 class="text-3xl font-semibold tracking-tight">Market Analysis</h2>
            <p class="text-secondary mt-1">Minervini Trend & Dual Momentum Strategies</p>
        </div>

        <div class="relative w-full md:w-96">
            <input type="text" id="tickerInput" placeholder="Search Markets (e.g. RELIANCE)"
                class="input-spotlight uppercase placeholder-gray-500">

            <div id="suggestions"
                class="absolute z-50 w-full bg-card backdrop-blur-xl border border-white/10 rounded-xl mt-2 hidden overflow-hidden shadow-2xl">
            </div>
        </div>
    </div>

    <!-- Market Overview -->
    {% if metrics %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Benchmark Card -->
        <a href="/?q=^NSEI" class="block group">
            <div class="card p-8 rounded-2xl relative overflow-hidden h-full group-hover:border-blue-500/50 transition">
                <!-- Subtle Gradient Glow -->
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 rounded-full blur-3xl -mr-10 -mt-10"></div>

                <h3 class="text-secondary text-xs font-bold uppercase tracking-wider mb-2">Benchmark</h3>
                <div class="flex items-baseline gap-3">
                    <div class="text-4xl font-light tracking-tight">{{ metrics.benchmark.name }}</div>
                    <div
                        class="text-lg font-mono {{ 'text-green-500' if metrics.benchmark.change_1y >= 0 else 'text-red-500' }}">
                        {{ "{:+,.2f}".format(metrics.benchmark.change_1y) }}%
                    </div>
                </div>

                <div class="mt-4 flex items-center gap-3">
                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-white/5 border border-white/10">
                        {{ metrics.benchmark.status }}
                    </span>
                    <span class="text-xs text-secondary uppercase">{{ metrics.benchmark.trend }}</span>
                </div>
            </div>
        </a>

        <!-- Breadth Card -->
        <div class="card p-8 rounded-2xl h-full">
            <h3 class="text-secondary text-xs font-bold uppercase tracking-wider mb-4">
                {{ metrics.breadth.label }}
            </h3>

            <div class="flex justify-between items-end mb-2">
                <div class="text-3xl font-light text-green-500">{{ metrics.breadth.bullish }}</div>
                <div class="text-xs text-secondary mb-1 uppercase tracking-wide">Bullish Stocks</div>
            </div>

            <!-- iOS Slider Style Progress -->
            <div class="relative w-full h-2 bg-white/10 rounded-full overflow-hidden flex">
                {% set total = metrics.breadth.total if metrics.breadth.total > 0 else 1 %}
                <div class="h-full bg-green-500" style="width: {{ (metrics.breadth.bullish / total) * 100 }}%"></div>
                <div class="h-full bg-orange-500" style="width: {{ (metrics.breadth.neutral / total) * 100 }}%"></div>
                <div class="h-full bg-red-500" style="width: {{ (metrics.breadth.bearish / total) * 100 }}%"></div>
            </div>

            <div class="flex justify-between mt-3 text-xs text-secondary">
                <span>{{ metrics.breadth.bearish }} Bearish</span>
                <span>{{ metrics.breadth.total }} Total</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Portfolio Tiles -->
    {% if portfolios %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {% for p in portfolios %}
        <a href="{{ url_for('portfolio_view', pid=p.id) }}" class="block group h-full">
            <div class="card p-6 rounded-2xl h-full flex flex-col hover:border-blue-500/30 transition shadow-lg">
                <div class="flex justify-between items-start mb-6">
                    <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-secondary">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <span class="text-xs font-mono text-secondary">{{ p.count }} Pos</span>
                </div>

                <h3 class="text-lg font-medium group-hover:text-blue-400 transition">{{ p.name }}</h3>

                <div class="mt-auto pt-4">
                    <div class="text-2xl font-light">₹{{ "{:,.0f}".format(p.current) }}</div>
                    <div class="text-sm font-mono mt-1 {{ 'text-green-500' if p.pnl >= 0 else 'text-red-500' }}">
                        {{ "{:+,.0f}".format(p.pnl) }} ({{ "{:+.1f}".format(p.pnl_pct) }}%)
                    </div>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Results Container -->
    <div id="loading" class="hidden text-center py-20">
        <div class="inline-block animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <div id="results" class="hidden space-y-8">
        <!-- Ticker Header -->
        <div
            class="card rounded-2xl p-8 flex justify-between items-center bg-gradient-to-r from-blue-900/20 to-transparent">
            <div>
                <h1 id="resTicker" class="text-5xl font-thin tracking-tighter">--</h1>
                <div class="text-3xl font-mono text-blue-400 mt-2">₹<span id="resPrice">--</span></div>
            </div>
            <div class="text-right">
                <div id="resSummaryBadge"
                    class="inline-block px-4 py-2 rounded-full text-sm font-bold bg-white/10 uppercase tracking-wide">--
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="card rounded-2xl overflow-hidden min-h-[600px]">
            <div class="flex border-b border-white/10">
                <button onclick="switchTab('minervini')" id="tab-minervini"
                    class="px-8 py-5 text-sm font-medium border-b-2 border-blue-500 text-blue-400 bg-white/5">Minervini
                    Trend</button>
                <button onclick="switchTab('dual')" id="tab-dual"
                    class="px-8 py-5 text-sm font-medium text-secondary hover:text-white transition">Dual
                    Momentum</button>
            </div>

            <!-- Content: Minervini -->
            <div id="content-minervini" class="p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-6">
                    <div class="p-6 rounded-2xl bg-white/5 border border-white/10">
                        <h3 class="text-xs font-bold text-secondary uppercase mb-2">Trend Status</h3>
                        <div id="minScore" class="text-3xl font-bold">--</div>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-secondary uppercase mb-3">Checklist</h3>
                        <ul id="minDetails" class="space-y-3 text-sm text-secondary"></ul>
                    </div>
                </div>
                <div id="min-chart-wrapper" class="lg:col-span-2 relative group">
                    <div id="minChartFrame" class="w-full h-[500px] rounded-xl bg-white/5 transition-all"></div>
                    <button onclick="toggleFullscreen('min-chart-wrapper', 'minChartFrame')"
                        class="absolute top-4 right-4 p-2 bg-black/50 hover:bg-black/70 backdrop-blur-md border border-white/10 rounded-lg text-white opacity-0 group-hover:opacity-100 transition duration-200 z-10"
                        title="Toggle Fullscreen">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Content: Dual -->
            <div id="content-dual" class="p-8 grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
                <div class="lg:col-span-1 space-y-6">
                    <div class="p-6 rounded-2xl bg-white/5 border border-white/10">
                        <h3 class="text-xs font-bold text-secondary uppercase mb-2">Signal</h3>
                        <div id="dualSignal" class="text-3xl font-bold">--</div>
                    </div>
                    <ul id="dualMetrics" class="space-y-4 text-sm"></ul>
                </div>
                <div id="dual-chart-wrapper" class="lg:col-span-2 relative group">
                    <div id="dualChartFrame" class="w-full h-[500px] rounded-xl bg-white/5 transition-all"></div>
                    <button onclick="toggleFullscreen('dual-chart-wrapper', 'dualChartFrame')"
                        class="absolute top-4 right-4 p-2 bg-black/50 hover:bg-black/70 backdrop-blur-md border border-white/10 rounded-lg text-white opacity-0 group-hover:opacity-100 transition duration-200 z-10"
                        title="Toggle Fullscreen">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function analyzeStock(tickerOverride) {
        const ticker = tickerOverride || document.getElementById('tickerInput').value;
        if (!ticker) return;

        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('results').classList.add('hidden');

        fetch(`/analyze_ticker?ticker=${encodeURIComponent(ticker)}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('loading').classList.add('hidden');
                if (data.error) { alert(data.error); return; }
                renderResults(data);
            })
            .catch(e => {
                alert("Analysis failed");
                document.getElementById('loading').classList.add('hidden');
            });
    }

    function renderResults(data) {
        document.getElementById('results').classList.remove('hidden');
        document.getElementById('resTicker').innerText = data.ticker;
        document.getElementById('resPrice').innerText = data.price;

        const summary = data.summary;
        const badge = document.getElementById('resSummaryBadge');
        badge.innerText = `${summary.strategies_passed} Strategies Passed`;
        badge.className = summary.bullish
            ? "inline-block px-4 py-2 rounded-full text-sm font-bold bg-green-500/20 text-green-400 border border-green-500/30 uppercase"
            : "inline-block px-4 py-2 rounded-full text-sm font-bold bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 uppercase";

        // Minervini
        const min = data.strategies['Minervini Trend Template'];
        const minScore = document.getElementById('minScore');
        minScore.innerText = min.status;
        minScore.className = min.status === 'PASS' ? "text-3xl font-bold text-green-400" : "text-3xl font-bold text-red-400";

        document.getElementById('minDetails').innerHTML = min.details.map(d =>
            `<li class="flex items-center"><span class="w-1.5 h-1.5 rounded-full bg-blue-500 mr-3"></span>${d}</li>`
        ).join('');

        if (min.chart_json) {
            const fig = JSON.parse(min.chart_json);
            const config = { responsive: true, displayModeBar: false };
            // Force transparent background for glass effect
            fig.layout.paper_bgcolor = 'rgba(0,0,0,0)';
            fig.layout.plot_bgcolor = 'rgba(0,0,0,0)';
            fig.layout.font = { color: '#a1a1aa' };
            Plotly.newPlot('minChartFrame', fig.data, fig.layout, config);
        }

        // Dual
        const dual = data.strategies['Dual Momentum (Antonacci)'];
        const dualSignal = document.getElementById('dualSignal');
        dualSignal.innerText = dual.signal;
        dualSignal.className = dual.signal === 'BUY' ? "text-3xl font-bold text-green-400" : "text-3xl font-bold text-secondary";

        const m = dual.metrics || {};
        document.getElementById('dualMetrics').innerHTML = `
            <li class="flex justify-between border-b border-white/5 pb-2"><span class="text-secondary">Stock 1Y</span> <span class="font-mono text-white">${m.Stock_1yr_Ret}</span></li>
            <li class="flex justify-between border-b border-white/5 pb-2"><span class="text-secondary">Benchmark 1Y</span> <span class="font-mono text-white">${m.Bench_1yr_Ret}</span></li>
            <li class="flex justify-between border-b border-white/5 pb-2"><span class="text-secondary">Alpha</span> <span class="font-bold text-blue-400">${m.Alpha}</span></li>
        `;

        if (dual.chart_json) {
            const fig = JSON.parse(dual.chart_json);
            fig.layout.paper_bgcolor = 'rgba(0,0,0,0)';
            fig.layout.plot_bgcolor = 'rgba(0,0,0,0)';
            fig.layout.font = { color: '#a1a1aa' };
            Plotly.newPlot('dualChartFrame', fig.data, fig.layout, { responsive: true, displayModeBar: false });
        }
    }

    function switchTab(tab) {
        ['minervini', 'dual'].forEach(t => {
            const btn = document.getElementById(`tab-${t}`);
            const content = document.getElementById(`content-${t}`);
            if (t === tab) {
                btn.className = "px-8 py-5 text-sm font-medium border-b-2 border-blue-500 text-blue-400 bg-white/5";
                content.classList.remove('hidden');
                if (t === 'minervini') Plotly.Plots.resize('minChartFrame');
                if (t === 'dual') Plotly.Plots.resize('dualChartFrame');
            } else {
                btn.className = "px-8 py-5 text-sm font-medium text-secondary hover:text-white transition";
                content.classList.add('hidden');
            }
        });
    }

    // Auto-search logic
    const input = document.getElementById('tickerInput');
    const suggestBox = document.getElementById('suggestions');

    input.addEventListener('input', async (e) => {
        const q = e.target.value;
        if (q.length < 2) { suggestBox.classList.add('hidden'); return; }
        try {
            const res = await fetch(`/suggest?q=${encodeURIComponent(q)}`);
            const list = await res.json();
            if (list.length > 0) {
                suggestBox.innerHTML = list.map(t =>
                    `<div class="px-4 py-3 hover:bg-white/10 cursor-pointer text-sm font-medium border-b border-white/5 last:border-0" onclick="selectTicker('${t}')">${t}</div>`
                ).join('');
                suggestBox.classList.remove('hidden');
            }
        } catch (e) { }
    });

    function selectTicker(t) {
        input.value = t;
        suggestBox.classList.add('hidden');
        analyzeStock();
    }

    // Enter key
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            suggestBox.classList.add('hidden');
            analyzeStock();
        }
    });

    function toggleFullscreen(wrapperId, chartId) {
        const wrapper = document.getElementById(wrapperId);
        const chart = document.getElementById(chartId);
        const isFullscreen = wrapper.dataset.fullscreen === 'true';

        if (!isFullscreen) {
            // ENTER FULLSCREEN

            // 1. Create Placeholder
            const placeholder = document.createElement('div');
            placeholder.id = wrapperId + '-placeholder';
            placeholder.style.display = 'none';
            wrapper.parentNode.insertBefore(placeholder, wrapper);

            // 2. Move to Body
            document.body.appendChild(wrapper);

            // 3. Apply Styles
            wrapper.classList.remove('lg:col-span-2', 'relative', 'group');
            wrapper.classList.add('fixed', 'inset-0', 'z-[9999]', 'bg-gray-900', 'flex', 'flex-col', 'p-6');

            chart.classList.remove('h-[500px]', 'rounded-xl', 'bg-white/5');
            chart.classList.add('flex-1', 'w-full', 'h-full');

            // 4. Update Button (Always visible)
            const btn = wrapper.querySelector('button');
            btn.classList.remove('opacity-0', 'group-hover:opacity-100', 'absolute');
            btn.classList.add('fixed', 'top-6', 'right-6', 'z-[10000]', 'bg-red-500/80', 'hover:bg-red-600');
            btn.innerHTML = '<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';

            wrapper.dataset.fullscreen = 'true';

        } else {
            // EXIT FULLSCREEN

            // 1. Find Placeholder
            const placeholder = document.getElementById(wrapperId + '-placeholder');

            // 2. Move back
            if (placeholder) {
                placeholder.parentNode.insertBefore(wrapper, placeholder);
                placeholder.remove();
            }

            // 3. Reset Styles
            wrapper.classList.add('lg:col-span-2', 'relative', 'group');
            wrapper.classList.remove('fixed', 'inset-0', 'z-[9999]', 'bg-gray-900', 'flex', 'flex-col', 'p-6');

            chart.classList.add('h-[500px]', 'rounded-xl', 'bg-white/5');
            chart.classList.remove('flex-1', 'w-full', 'h-full');

            // 4. Reset Button
            const btn = wrapper.querySelector('button');
            btn.classList.add('opacity-0', 'group-hover:opacity-100', 'absolute');
            btn.classList.remove('fixed', 'top-6', 'right-6', 'z-[10000]', 'bg-red-500/80', 'hover:bg-red-600');
            btn.innerHTML = '<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>';

            wrapper.dataset.fullscreen = 'false';
        }

        // Force resize
        setTimeout(() => Plotly.Plots.resize(chartId), 50);
    }

    // Auto-load
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const ticker = params.get('q');
        if (ticker) {
            document.getElementById('tickerInput').value = ticker;
            analyzeStock(ticker);
        }
    });
</script>
{% endblock %}