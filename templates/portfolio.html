{% extends "layouts/base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">

    <!-- Header & Metrics -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <div class="lg:col-span-3 flex flex-col justify-end">
            <div class="flex items-baseline gap-3">
                <h2 class="text-3xl font-light tracking-tight">{{ current_ptf_name }}</h2>
                {% if current_pid != 'all' %}
                <button onclick="renamePortfolio({{ current_pid }}, '{{ current_ptf_name }}')"
                    class="text-secondary hover:text-white transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                        </path>
                    </svg>
                </button>
                {% endif %}
            </div>
            <p class="text-secondary text-sm mt-1">Portfolio Performance & Momentum Health</p>
        </div>

        <div class="lg:col-span-1 card rounded-xl p-4 flex flex-col gap-1">
            <span class="text-xs uppercase font-bold text-secondary">Total P/L</span>
            <div class="flex items-baseline gap-2">
                <span class="text-2xl font-mono {{ 'text-green-500' if summary.total_pnl >= 0 else 'text-red-500' }}">{{
                    "{:+,.0f}".format(summary.total_pnl) }}</span>
                <span class="text-xs text-secondary">({{ "{:+.1f}".format(summary.total_pnl_pct) }}%)</span>
            </div>
            <div class="text-xs text-secondary mt-2 flex justify-between">
                <span>Value: ₹{{ "{:,.0f}".format(summary.current_value) }}</span>
                <span>Inv: ₹{{ "{:,.0f}".format(summary.total_invested) }}</span>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="flex justify-between items-center">
        <!-- Portfolio Switcher Pill -->
        <div class="flex items-center gap-2 overflow-x-auto pb-2">
            <a href="{{ url_for('portfolio_view', pid='all') }}"
                class="px-4 py-1.5 rounded-full text-xs font-semibold whitespace-nowrap transition border {{ 'bg-blue-600 text-white border-blue-500' if current_pid == 'all' else 'bg-white/5 text-secondary border-white/10 hover:text-white' }}">
                All
            </a>
            {% for p in portfolios %}
            <a href="{{ url_for('portfolio_view', pid=p.id) }}"
                class="px-4 py-1.5 rounded-full text-xs font-semibold whitespace-nowrap transition border {{ 'bg-blue-600 text-white border-blue-500' if current_pid == p.id else 'bg-white/5 text-secondary border-white/10 hover:text-white' }}">
                {{ p.name }}
            </a>
            {% endfor %}
            <button onclick="createPortfolio()"
                class="px-3 py-1.5 rounded-full text-xs font-bold text-blue-400 border border-blue-400/30 hover:bg-blue-400/10">+</button>
        </div>

        <div class="flex gap-3">
            <button onclick="runPortfolioScan()" id="scanBtn"
                class="bg-white/5 border border-white/10 hover:bg-white/10 text-white px-4 py-2 rounded-lg text-xs font-semibold transition">
                ↻ Scan Health
            </button>
            {% if current_pid != 'all' %}
            <button onclick="openModal()"
                class="bg-white text-black px-4 py-2 rounded-lg text-xs font-bold hover:bg-gray-200 transition">
                + Add Stock
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Finder-Style Table -->
    <div class="card rounded-xl overflow-hidden min-h-[500px]">
        <div class="overflow-x-auto">
            <table class="finder-table" id="portfolioTable">
                <thead>
                    <tr>
                        <th class="cursor-pointer hover:text-white transition" onclick="sortTable(0)">Stock</th>
                        <th class="text-right">Holdings</th>
                        <th class="text-right cursor-pointer hover:text-white transition w-[1%] whitespace-nowrap"
                            onclick="sortTable(2)">Value
                        </th>
                        <th class="text-right cursor-pointer hover:text-white transition w-[1%] whitespace-nowrap"
                            onclick="sortTable(3)">P/L
                        </th>
                        <th class="text-center cursor-pointer hover:text-white transition" onclick="sortTable(4)">Health
                        </th>
                        <th class="text-center w-[1%] whitespace-nowrap">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    {% for stock in stocks %}
                    <tr class="group cursor-default hover:bg-white/5 transition" id="row-{{ stock.ticker }}">
                        <td class="pl-4 whitespace-nowrap w-[1%]">
                            <div class="font-medium text-white stock-ticker">{{ stock.ticker }}</div>
                            <div class="text-[10px] text-secondary">{{ stock.original_name }}</div>
                        </td>
                        <td class="text-right whitespace-nowrap" data-sort="{{ stock.quantity }}">
                            <div class="font-mono text-white">{{ "{:,.0f}".format(stock.quantity) }}</div>
                            <div class="text-[10px] text-secondary">@ {{ "{:,.1f}".format(stock.avg_price) }}</div>
                        </td>
                        <td class="text-right font-mono text-white whitespace-nowrap w-[1%]"
                            data-sort="{{ stock.current_value }}">
                            <div>₹{{ "{:,.0f}".format(stock.current_value) }}</div>
                            <div class="text-[10px] text-secondary">Inv: ₹{{ "{:,.0f}".format(stock.invested_value) }}
                            </div>
                        </td>
                        <td class="text-right font-mono whitespace-nowrap w-[1%]" data-sort="{{ stock.pnl }}">
                            <span class="{{ 'text-green-500' if stock.pnl >= 0 else 'text-red-500' }}">
                                {{ "{:+,.0f}".format(stock.pnl) }}
                            </span>
                            <span class="text-[10px] opacity-70 block">({{ "{:+.1f}".format(stock.pnl_pct) }}%)</span>
                        </td>
                        <td class="text-center whitespace-nowrap" data-sort="{{ 0 }}">
                            <!-- Basic simplified status badge -->
                            <span
                                class="status-badge px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border border-white/10 bg-white/5 text-secondary">
                                Waiting
                            </span>
                        </td>
                        <td class="text-center whitespace-nowrap w-[1%]">
                            <div
                                class="flex justify-center items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <a href="{{ url_for('home', q=stock.ticker) }}"
                                    class="p-1.5 rounded-md hover:bg-blue-500/20 text-blue-400 transition"
                                    title="Analyze">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                        </path>
                                    </svg>
                                </a>
                                {% if current_pid != 'all' %}
                                <button
                                    onclick="openModal('{{ stock.ticker }}', {{ stock.quantity }}, {{ stock.avg_price }})"
                                    class="p-1.5 rounded-md hover:bg-white/10 text-gray-400 hover:text-white transition"
                                    title="Edit">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                        </path>
                                    </svg>
                                </button>
                                <button onclick="removeStock('{{ stock.ticker }}')"
                                    class="p-1.5 rounded-md hover:bg-red-500/20 text-gray-400 hover:text-red-500 transition"
                                    title="Remove">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal logic (Reuse JS logic but cleaner HTML) -->
<div id="stockModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-[#1c1c1e] rounded-xl p-6 w-96 border border-white/10 shadow-2xl">
        <h3 id="modalTitle" class="text-lg font-semibold text-white mb-6">Add Stock</h3>
        <input type="hidden" id="isEdit" value="false">
        <div class="space-y-4">
            <div>
                <label class="block text-xs text-secondary uppercase mb-1">Ticker</label>
                <input type="text" id="mTicker" class="input-spotlight text-sm py-2 px-3 uppercase">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs text-secondary uppercase mb-1">Quantity</label>
                    <input type="number" id="mQty" class="input-spotlight text-sm py-2 px-3">
                </div>
                <div>
                    <label class="block text-xs text-secondary uppercase mb-1">Avg Price</label>
                    <input type="number" id="mPrice" class="input-spotlight text-sm py-2 px-3">
                </div>
            </div>
            <div>
                <label class="block text-xs text-secondary uppercase mb-1">Date</label>
                <input type="date" id="mDate" class="input-spotlight text-sm py-2 px-3 text-white">
            </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
            <button onclick="closeModal()" class="px-4 py-2 text-sm text-secondary hover:text-white">Cancel</button>
            <button onclick="saveStock()"
                class="px-6 py-2 bg-white text-black rounded-lg text-sm font-bold hover:bg-gray-200">Save</button>
        </div>
    </div>
</div>

<script>
    const CURRENT_PID = "{{ current_pid }}";

    function openModal(ticker = null, qty = null, price = null) {
        const modal = document.getElementById('stockModal');
        const mTicker = document.getElementById('mTicker');
        const mQty = document.getElementById('mQty');
        const mPrice = document.getElementById('mPrice');
        const mDate = document.getElementById('mDate');

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        if (ticker) {
            document.getElementById('modalTitle').innerText = "Edit Stock";
            mTicker.value = ticker;
            mTicker.disabled = true;
            mQty.value = "";
            mPrice.value = price;
            document.getElementById('isEdit').value = "true";
            mQty.focus();
        } else {
            document.getElementById('modalTitle').innerText = "Add Stock";
            mTicker.value = "";
            mTicker.disabled = false;
            mQty.value = "";
            mPrice.value = "";
            document.getElementById('isEdit').value = "false";
            mTicker.focus();
        }
        mDate.value = new Date().toISOString().split('T')[0];
    }

    function closeModal() {
        document.getElementById('stockModal').classList.add('hidden');
        document.getElementById('stockModal').classList.remove('flex');
    }

    async function saveStock() {
        const ticker = document.getElementById('mTicker').value;
        const qty = document.getElementById('mQty').value;
        const price = document.getElementById('mPrice').value;
        const date = document.getElementById('mDate').value;
        const isEdit = document.getElementById('isEdit').value === "true";

        if (!ticker || !qty || !price) { alert("Fill all fields"); return; }

        let pid = CURRENT_PID === 'all' ? 1 : CURRENT_PID;

        try {
            const endpoint = isEdit ? '/portfolio/update' : '/add_stock';
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ticker, quantity: qty, avg_price: price, portfolio_id: pid, purchase_date: date })
            });
            const data = await res.json();
            if (data.status === 'success' || data.success) location.reload();
            else alert(data.message || "Error");
        } catch (e) { alert("Failed"); }
    }

    async function removeStock(ticker) {
        if (!confirm(`Remove ${ticker}?`)) return;
        try {
            const res = await fetch('/portfolio/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ticker, portfolio_id: CURRENT_PID })
            });
            if ((await res.json()).success) location.reload();
        } catch (e) { }
    }

    async function createPortfolio() {
        const name = prompt("New Portfolio Name:");
        if (!name) return;
        try {
            const res = await fetch('/api/portfolios', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            const data = await res.json();
            if (data.success) window.location.href = `{{ url_for('portfolio_view') }}?pid=${data.id}`;
        } catch (e) { }
    }

    // Sorting Logic
    let sortDirection = 1;
    function sortTable(n) {
        const tbody = document.querySelector('#portfolioTable tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        sortDirection *= -1;
        rows.sort((a, b) => {
            const cellA = a.children[n];
            const cellB = b.children[n];
            let valA = cellA.getAttribute('data-sort') || cellA.innerText.trim();
            let valB = cellB.getAttribute('data-sort') || cellB.innerText.trim();
            const numA = parseFloat(valA);
            const numB = parseFloat(valB);
            return (!isNaN(numA) && !isNaN(numB)) ? (numA - numB) * sortDirection : valA.localeCompare(valB) * sortDirection;
        });
        rows.forEach(row => tbody.appendChild(row));
    }

    // Scan Logic reused from before but simplified
    async function runPortfolioScan() {
        const btn = document.getElementById('scanBtn');
        btn.disabled = true;
        btn.innerText = "Analyzing...";

        const rows = document.querySelectorAll('tr[id^="row-"]');
        for (let row of rows) {
            const ticker = row.querySelector('.stock-ticker').innerText;
            const badge = row.querySelector('.status-badge');
            if (!badge) continue;

            badge.className = "px-2 py-0.5 rounded text-[10px] font-bold uppercase border border-yellow-500/30 text-yellow-500 animate-pulse";
            badge.innerText = "...";

            try {
                const res = await fetch(`/analyze_ticker?ticker=${encodeURIComponent(ticker)}`);
                const data = await res.json();

                if (data.error) { badge.innerText = "Error"; badge.className = "px-2 py-0.5 rounded text-[10px] uppercase text-red-500"; continue; }

                const passed = parseInt(data.summary.strategies_passed.split('/')[0]);
                const total = parseInt(data.summary.strategies_passed.split('/')[1]);

                if (passed === total) {
                    badge.innerText = "STRONG BUY";
                    badge.className = "px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-green-500/20 text-green-400 border border-green-500/30";
                } else if (passed > 0) {
                    badge.innerText = "MIXED";
                    badge.className = "px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-yellow-500/20 text-yellow-400 border border-yellow-500/30";
                } else {
                    badge.innerText = "WEAK";
                    badge.className = "px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-red-500/20 text-red-400 border border-red-500/30";
                }
            } catch (e) {
                badge.innerText = "Fail";
            }
        }
        btn.innerText = "Scan Complete";
        btn.disabled = false;
    }
</script>
{% endblock %}